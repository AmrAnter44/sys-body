name: Build and Deploy Gym System

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Generate Prisma Client
      run: npx prisma generate

    - name: Build application
      run: npm run build
      env:
        NODE_ENV: production
        NEXT_TELEMETRY_DISABLED: 1
        JWT_SECRET: temp-build-secret-not-for-production
        DATABASE_URL: file:./prisma/gym.db

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: |
          .next/
          public/
          package.json
          package-lock.json
          prisma/
        retention-days: 7

  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files

    - name: Get version from package.json
      id: package-version
      run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

    - name: Create deployment package
      run: |
        mkdir -p gym-system-release
        cp -r .next gym-system-release/
        cp -r public gym-system-release/
        cp -r prisma gym-system-release/
        cp package.json gym-system-release/
        cp package-lock.json gym-system-release/
        cp .env.example gym-system-release/.env
        cp PRODUCTION_SETUP.md gym-system-release/
        cp GODADDY_SETUP.md gym-system-release/
        cp start-production.bat gym-system-release/
        cp backup-database.bat gym-system-release/
        cp ecosystem.config.js gym-system-release/

        # Create installation script
        cat > gym-system-release/INSTALL.md << 'EOF'
# ØªØ«Ø¨ÙŠØª Ø§Ù„Ù†Ø¸Ø§Ù… - Ø¯Ù„ÙŠÙ„ Ø³Ø±ÙŠØ¹

## Ø§Ù„Ø®Ø·ÙˆØ§Øª:

1. **Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù„ÙØ§Øª**
   ```bash
   # ÙÙƒ Ø¶ØºØ· Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
   ```

2. **ØªØ«Ø¨ÙŠØª Dependencies**
   ```bash
   npm install --production
   ```

3. **Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©**
   ```bash
   # Ø§ÙØªØ­ Ù…Ù„Ù .env ÙˆØºÙŠÙ‘Ø±:
   # - JWT_SECRET
   # - NEXT_PUBLIC_APP_URL
   ```

4. **Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª**
   ```bash
   npx prisma generate
   npx prisma db push
   ```

5. **Ø§Ù„ØªØ´ØºÙŠÙ„**
   ```bash
   # Windows:
   start-production.bat

   # Linux/Mac:
   npm start
   ```

Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„ØŒ Ø±Ø§Ø¬Ø¹ PRODUCTION_SETUP.md Ùˆ GODADDY_SETUP.md
EOF

        # Create zip file
        cd gym-system-release
        zip -r ../gym-system-v${{ steps.package-version.outputs.version }}.zip .
        cd ..

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.package-version.outputs.version }}
        name: Gym System v${{ steps.package-version.outputs.version }}
        body: |
          ## Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙŠÙ… - Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${{ steps.package-version.outputs.version }}

          ### Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±:
          - âœ… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØ§Ù„Ø²ÙˆØ§Ø±
          - âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
          - âœ… Ø­Ø¬ÙˆØ²Ø§Øª SPA (Ø³Ø§ÙˆÙ†Ø§ØŒ Ù…Ø³Ø§Ø¬ØŒ Ø¬Ø§ÙƒÙˆØ²ÙŠ)
          - âœ… Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª
          - âœ… PWA - Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ«Ø¨ÙŠØª ÙƒØªØ·Ø¨ÙŠÙ‚ Ù…ÙˆØ¨Ø§ÙŠÙ„
          - âœ… Ø¯Ø¹Ù… ÙƒØ§Ù…Ù„ Ù„Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
          - âœ… Ù†Ø¸Ø§Ù… ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…

          ### Ø§Ù„ØªØ«Ø¨ÙŠØª:
          1. Ø­Ù…Ù‘Ù„ Ù…Ù„Ù `gym-system-v${{ steps.package-version.outputs.version }}.zip`
          2. ÙÙƒ Ø§Ù„Ø¶ØºØ·
          3. Ø§ØªØ¨Ø¹ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù…Ù„Ù `INSTALL.md`

          ### Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª:
          - Node.js 18 Ø£Ùˆ Ø£Ø­Ø¯Ø«
          - Windows/Linux/Mac

          ### Ø§Ù„Ø¯Ø¹Ù…:
          - WhatsApp: https://wa.me/201028518754
          - Ø§Ù„Ù…ÙˆÙ‚Ø¹: https://fitboost.website

          ðŸš€ **Ù„Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹:** Ø´ØºÙ‘Ù„ Ù…Ù„Ù `start-production.bat`
        files: |
          gym-system-v${{ steps.package-version.outputs.version }}.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
